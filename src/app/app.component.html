<div class="app-container">
  <!-- Header -->
  <mat-toolbar color="primary">
    <mat-icon>cake</mat-icon>
    <span class="toolbar-title">{{ title }}</span>
  </mat-toolbar>

  <div class="content-container">
    <!-- Dashboard Section -->
    <app-dashboard *ngIf="(birthdays$ | async)?.length! > 0"></app-dashboard>

    <!-- Birthday form -->
    <mat-card class="add-birthday-card">
      <mat-card-header>
        <mat-card-title>Add Birthday</mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="birthdayForm" (ngSubmit)="onSubmit()" class="birthday-form">
          <!-- Name -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Name</mat-label>
            <input matInput formControlName="name" placeholder="e.g. John Doe">
            <mat-icon matSuffix>person</mat-icon>
          </mat-form-field>

          <!-- Birth date -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Birth Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="birthDate">
            <mat-hint>Click the icon to open calendar</mat-hint>
            <mat-error *ngIf="birthdayForm.get('birthDate')?.hasError('required')">
              Birth date is required
            </mat-error>
            <mat-error *ngIf="birthdayForm.get('birthDate')?.hasError('futureDate')">
              Birth date cannot be in the future
            </mat-error>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <!-- Optional notes -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notes (optional)</mat-label>
            <textarea matInput formControlName="notes" placeholder="e.g. Gift: cooking book" rows="2"></textarea>
            <mat-icon matSuffix>notes</mat-icon>
          </mat-form-field>

          <!-- Reminder days -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Reminder Days</mat-label>
            <input matInput type="number" formControlName="reminderDays" min="1" max="365">
            <mat-hint>How many days before do you want to be reminded?</mat-hint>
            <mat-icon matSuffix>notifications</mat-icon>
          </mat-form-field>

          <!-- Submit button -->
          <div class="form-actions">
            <button 
              mat-raised-button 
              color="primary" 
              type="submit" 
              [disabled]="birthdayForm.invalid"
              class="submit-button">
              <mat-icon>add</mat-icon>
              Add Birthday
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Birthdays list -->
    <mat-card class="birthdays-list-card">
      <mat-card-header>
        <mat-card-title>Your Birthdays</mat-card-title>
        <mat-card-subtitle>{{ (birthdays$ | async)?.length || 0 }} birthdays saved</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <!-- Search and Filter Section -->
        <div class="filters-section">
          <!-- Search Bar -->
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search by name</mat-label>
            <input matInput 
                   placeholder="Type to search..." 
                   (input)="onSearchChange($event)">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Month Filter -->
          <mat-form-field appearance="outline" class="month-filter">
            <mat-label>Filter by month</mat-label>
            <mat-select [value]="selectedMonth$ | async" 
                       (selectionChange)="onMonthChange($event.value)">
              <mat-option [value]="null">All months</mat-option>
              <mat-option *ngFor="let month of months; let i = index" [value]="i">
                {{ month }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>event</mat-icon>
          </mat-form-field>

          <!-- Sort Options -->
          <mat-form-field appearance="outline" class="sort-field">
            <mat-label>Sort by</mat-label>
            <mat-select [value]="sortOrder$ | async" 
                       (selectionChange)="onSortChange($event.value)">
              <mat-option *ngFor="let option of sortOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>sort</mat-icon>
          </mat-form-field>

          <!-- Clear Filters Button -->
          <button mat-stroked-button 
                  color="primary" 
                  (click)="clearFilters()"
                  class="clear-filters-btn"
                  matTooltip="Clear all filters">
            <mat-icon>clear</mat-icon>
            Clear
          </button>
        </div>

        <!-- Active Filters Display -->
        <div class="active-filters" *ngIf="(searchTerm$ | async) || (selectedMonth$ | async) !== null">
          <span class="filters-label">Active filters:</span>
          <mat-chip-set>
            <mat-chip *ngIf="searchTerm$ | async as search" 
                     (removed)="onSearchChange({target: {value: ''}})">
              Search: "{{ search }}"
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
            <mat-chip *ngIf="(selectedMonth$ | async) !== null" 
                     (removed)="onMonthChange(null)">
              Month: {{ getMonthName(selectedMonth$ | async) }}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
          </mat-chip-set>
        </div>

        <!-- Results Info -->
        <div class="results-info">
          <span>Showing {{ (filteredBirthdays$ | async)?.length || 0 }} of {{ (birthdays$ | async)?.length || 0 }} birthdays</span>
        </div>

        <!-- Birthdays List or Empty State -->
        <div *ngIf="(filteredBirthdays$ | async)?.length === 0; else birthdaysList" class="no-birthdays">
          <mat-icon class="large-icon">
            {{ (birthdays$ | async)?.length === 0 ? 'cake' : 'search_off' }}
          </mat-icon>
          <p *ngIf="(birthdays$ | async)?.length === 0; else noResults">
            You haven't added any birthdays yet!
          </p>
          <ng-template #noResults>
            <p>No birthdays match your current filters.</p>
            <button mat-button color="primary" (click)="clearFilters()">
              Clear filters
            </button>
          </ng-template>
          <p *ngIf="(birthdays$ | async)?.length === 0">Use the form above to add your first one.</p>
        </div>

        <ng-template #birthdaysList>
          <mat-list>
            <mat-list-item *ngFor="let birthday of filteredBirthdays$ | async" class="birthday-item">
              <mat-icon matListItemIcon color="primary">person</mat-icon>
              
              <div matListItemTitle class="birthday-info">
                <div class="name">{{ birthday.name }}</div>
                <div class="age">{{ calculateAge(birthday.birthDate) }} years old</div>
              </div>
              
              <div matListItemLine class="birthday-details">
                <span class="birth-date">
                  <mat-icon class="small-icon">event</mat-icon>
                  {{ birthday.birthDate | date:'MM/dd/yyyy' }}
                </span>
                <span class="next-birthday" [class.today]="getNextBirthdayText(birthday.birthDate) === 'Today!'" 
                      [class.tomorrow]="getNextBirthdayText(birthday.birthDate) === 'Tomorrow!'">
                  {{ getNextBirthdayText(birthday.birthDate) }}
                </span>
              </div>
              
              <div matListItemLine *ngIf="birthday.notes" class="notes">
                <mat-icon class="small-icon">notes</mat-icon>
                {{ birthday.notes }}
              </div>

              <button 
                mat-icon-button 
                color="warn" 
                (click)="deleteBirthday(birthday.id)"
                matTooltip="Delete birthday"
                class="delete-button">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-list-item>
            
            <mat-divider *ngIf="(filteredBirthdays$ | async)?.length! > 1"></mat-divider>
          </mat-list>
        </ng-template>
      </mat-card-content>
    </mat-card>
  </div>
</div>